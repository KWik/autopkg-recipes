#!/usr/local/autopkg/python
"""Generates a FleetDM bind pkg using fleetctl"""

from autopkglib import Processor, ProcessorError

import pathlib
import subprocess
import sys

__all__ = ["FleetBindPkg"]

def reverse_domain(url:str) -> str:
    return '.'.join(reversed(url.split('/')[-1].split('.')))
    

class FleetBindPkg(Processor):

    description = __doc__
    input_variables = {
        "fleetctl_path": {
            "required": True,
            "description": "Path to fleetctl binary",
        },
        "FLEET_SERVER_URL": {
            "required": True,
            "description": "URL to FleetDM server",
        },
        "FLEET_SERVER_ENROLL_SECRET": {
            "required": True,
            "description": "Enrollmen secret for FleetDM server",
        },
        "FLEET_BIND_PKG_IDENTIFIER": {
            "required": False,
            "description": "Identifier for output pkg",
        },
        "FLEET_BIND_PKG_NAME": {
            "required": False,
            "description": "Filename for output pkg",
        },


    }

    output_variables = {
        "fleetbindpkg": { "description": "Path to fleetdm pkg" },
        "fleetctl_version": { "description": "Version of fleetctl" }
    }

    def main(self):
        try:
            # Anything vital must be within the try
            fleet_url = self.env["FLEET_SERVER_URL"]
            fleet_enroll_secret = self.env["FLEET_SERVER_ENROLL_SECRET"]
            fleet_server_url = self.env["FLEET_SERVER_URL"]
            
            fleetctl = pathlib.Path(self.env["fleetctl_path"])
            outdir = pathlib.Path(self.env["RECIPE_CACHE_DIR"]) / self.env["NAME"]
            outdir.mkdir(parents=True, exist_ok=True)

            result = subprocess.run([f'{fleetctl}', '--version'],
                           capture_output=True,
                           text=True,
                           check=True)

            print(result.stdout)
            return
            
            if pkg_name := self.env.get("FLEET_BIND_PKG_NAME"):
                pass
            else:
                pkg_name = self.env.get("NAME")

            run_arguments = [f'package',
                             f'--type=pkg',
                             f'--outfile={pkg_path}'
                             f'--fleet-url={fleet_server_url}',
                             f'--enroll-secret={fleet_enroll_secret}']

            
            if pkg_identifier := self.env.get("FLEET_BIND_PKG_IDENTIFIER"):
                run_arguments.append(f'--indentifier={pkg_identifier}')

            #     --arch="aamd64"
            #     --fleet-certificate="{instance}.pem"
            
            # subprocess.run(['/tmp/dumpargs.py'] + run_arguments )
            # self.output(result.stdout)
        except Exception as err:
            raise ProcessorError(err)
        self.env["fleetbindpkg"] = f'{pkg_path}'
        self.env["fleetctl_version"] = self.env["version"].split('v')[-1]
        
if __name__ == "__main__":
    PROC = FleetBindPkg()
    PROC.execute_shell()

